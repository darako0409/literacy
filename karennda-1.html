<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025年カレンダー</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }
        .day-cell {
            min-height: 120px;
            border: 1px solid #e5e7eb;
            padding: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
            background-color: white;
            overflow: hidden;
        }
        .day-cell.prev-month, .day-cell.next-month {
            color: #d1d5db;
        }
        .day-cell:not(.prev-month):not(.next-month):hover {
            background-color: #f9fafb;
        }
        .day-number {
            font-size: 1.5rem;
            font-weight: 600;
        }
        .day-cell.today {
            border: 2px solid #3b82f6;
        }
        .holiday {
            color: #ef4444;
        }
        .saturday {
            color: #3b82f6;
        }
        .event-item {
            font-size: 0.875rem;
            color: #4b5563;
            padding: 2px 4px;
            border-radius: 4px;
            margin-top: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .event-item.event {
            background-color: #e5e7eb;
        }
        .todo-item {
            font-size: 0.875rem;
            color: #4b5563;
            background-color: #d1fae5; /* 緑色 */
            padding: 2px 4px;
            border-radius: 4px;
            margin-top: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .todo-item.completed {
            text-decoration: line-through;
            background-color: #f3f4f6;
            color: #9ca3af;
        }
        .incomplete-todo-item {
            position: relative;
        }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-6 mb-8">
        <div class="flex items-center justify-between mb-6">
            <h1 class="text-3xl font-bold text-gray-800">2025年 カレンダー</h1>
            <div class="flex space-x-2">
                <button id="prevMonthBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-600 font-bold py-2 px-4 rounded-full transition-colors">&lt;</button>
                <span id="currentMonthYear" class="text-2xl font-semibold text-gray-700 self-center"></span>
                <button id="nextMonthBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-600 font-bold py-2 px-4 rounded-full transition-colors">&gt;</button>
            </div>
        </div>

        <div class="calendar-container rounded-lg overflow-hidden border border-gray-200">
            <div class="calendar-header calendar-grid text-center font-semibold bg-gray-200 text-gray-700 py-2">
                <div class="saturday">日</div>
                <div>月</div>
                <div>火</div>
                <div>水</div>
                <div>木</div>
                <div>金</div>
                <div class="holiday">土</div>
            </div>
            <div id="calendar" class="calendar-grid">
                <!-- カレンダーの日付がここに生成されます -->
            </div>
        </div>
    </div>
    
    <!-- 目標と課題点 -->
    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-6 mb-8">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold">目標</h2>
            <button id="editGoalBtn" class="bg-blue-500 hover:bg-blue-600 text-white py-1 px-4 rounded-full transition-colors">編集</button>
        </div>
        <div id="goalDisplay" class="p-4 border border-gray-200 rounded-lg bg-gray-50 whitespace-pre-wrap min-h-[10rem] text-gray-800"></div>

        <div class="flex justify-between items-center mt-6 mb-4">
            <h2 class="text-2xl font-bold">課題点</h2>
            <button id="editIssueBtn" class="bg-blue-500 hover:bg-blue-600 text-white py-1 px-4 rounded-full transition-colors">編集</button>
        </div>
        <div id="issueDisplay" class="p-4 border border-gray-200 rounded-lg bg-gray-50 whitespace-pre-wrap min-h-[10rem] text-gray-800"></div>
    </div>

    <!-- 未完了TODOリスト -->
    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-6 mb-8">
        <h2 class="text-2xl font-bold mb-4">未完了のやることリスト</h2>
        <div id="incompleteTodos" class="space-y-4">
            <!-- 未完了のTODOリストがここに生成されます -->
        </div>
    </div>

    <!-- カレンダー用モーダルウィンドウ -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-xl">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modalDate" class="text-2xl font-bold"></h2>
                <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
            </div>
            
            <h3 class="text-lg font-semibold mb-2">予定</h3>
            <div class="flex items-center mb-4">
                <textarea id="eventInput" class="flex-1 h-24 p-2 border rounded resize-none focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="予定を入力..."></textarea>
                <div class="ml-2 flex flex-col items-center">
                    <label for="eventColor" class="text-sm font-semibold text-gray-700">色</label>
                    <input type="color" id="eventColor" class="w-10 h-10 p-1 border rounded-md cursor-pointer">
                </div>
            </div>

            <h3 class="text-lg font-semibold mb-2">やることリスト</h3>
            <div id="todoList" class="space-y-2">
                <!-- TODOリストの項目がここに生成されます -->
            </div>
            <div class="flex mt-4 space-x-2">
                <input type="text" id="newTodoInput" class="flex-1 p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="新しいやること...">
                <button id="addTodoBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition-colors">追加</button>
            </div>
            <div class="flex justify-end mt-4">
                <button id="saveBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition-colors">保存</button>
            </div>
        </div>
    </div>

    <!-- 目標・課題点用モーダルウィンドウ -->
    <div id="notesModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-xl">
            <div class="flex justify-between items-center mb-4">
                <h2 id="notesModalTitle" class="text-2xl font-bold"></h2>
                <button id="closeNotesModalBtn" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
            </div>
            <textarea id="notesInput" class="w-full h-48 p-2 mb-4 border rounded resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
            <div class="flex justify-end mt-4 space-x-2">
                <button id="cancelNotesBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold py-2 px-4 rounded transition-colors">キャンセル</button>
                <button id="saveNotesBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition-colors">保存</button>
            </div>
        </div>
    </div>
    
    <div id="statusMessage" class="fixed bottom-4 left-1/2 -translate-x-1/2 bg-gray-800 text-white text-sm py-2 px-4 rounded-full shadow-lg transition-opacity duration-300 opacity-0"></div>

    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-6 mt-8">
        <h2 class="text-xl font-semibold text-gray-600 mb-2">ログイン中のユーザーID:</h2>
        <span id="userIdDisplay" class="font-mono bg-gray-200 text-gray-800 p-2 rounded-md block break-words"></span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD1as9zQr8P6k8Up9Y4FnO3DYroyvgMnAM",
            authDomain: "karennda-e8465.firebaseapp.com",
            projectId: "karennda-e8465",
            storageBucket: "karennda-e8465.firebasestorage.app",
            messagingSenderId: "1023443880200",
            appId: "1:1023443880200:web:ee995edd613fbc626544bd",
            measurementId: "G-E9Y0L9P95V"
        };
        
        let app = null;
        let db = null;
        let auth = null;
        
        if (firebaseConfig.projectId) {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (e) {
                console.error("Firebase initialization failed:", e);
            }
        } else {
            console.error("Firebase config is not available. Please add your config.");
        }

        const showStatusMessage = (message) => {
            const statusEl = document.getElementById('statusMessage');
            if (!statusEl) return;
            statusEl.textContent = message;
            statusEl.classList.remove('opacity-0');
            statusEl.classList.add('opacity-100');
            setTimeout(() => {
                statusEl.classList.remove('opacity-100');
                statusEl.classList.add('opacity-0');
            }, 3000);
        };

        let currentUserId = null;
        let eventData = {};
        let generalNotesData = {};
        let currentEditingField = null;

        const userIdDisplayEl = document.getElementById('userIdDisplay');
        const goalDisplayEl = document.getElementById('goalDisplay');
        const issueDisplayEl = document.getElementById('issueDisplay');
        const editGoalBtn = document.getElementById('editGoalBtn');
        const editIssueBtn = document.getElementById('editIssueBtn');
        const notesModalEl = document.getElementById('notesModal');
        const notesModalTitleEl = document.getElementById('notesModalTitle');
        const notesInputEl = document.getElementById('notesInput');
        const closeNotesModalBtn = document.getElementById('closeNotesModalBtn');
        const saveNotesBtn = document.getElementById('saveNotesBtn');
        const cancelNotesBtn = document.getElementById('cancelNotesBtn');
        const eventColorInput = document.getElementById('eventColor');

        const authAndInit = async () => {
            if (!auth || !db) {
                showStatusMessage('ローカルモードで実行中。データは保存されません。');
                renderCalendar(currentYear, currentMonth);
                renderIncompleteTodos();
                return;
            }
            try {
                await signInAnonymously(auth);
                currentUserId = auth.currentUser.uid;
                userIdDisplayEl.textContent = currentUserId;
                showStatusMessage(`ログインしました。データロード中です...`);
                initFirestoreListeners();
            } catch (error) {
                console.error("Firebase Authentication Error:", error);
                showStatusMessage('ログインに失敗しました。');
            }
        };

        const initFirestoreListeners = () => {
            if (!currentUserId || !db) return;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            const sharedCalendarCollectionPath = `/artifacts/${appId}/public/data/calendar_events`;
            const sharedCalendarCollectionRef = collection(db, sharedCalendarCollectionPath);
            onSnapshot(sharedCalendarCollectionRef, (snapshot) => {
                const newEventData = {};
                snapshot.forEach((doc) => {
                    newEventData[doc.id] = doc.data();
                });
                eventData = newEventData;
                renderCalendar(currentYear, currentMonth);
                renderIncompleteTodos();
                showStatusMessage('カレンダーデータが更新されました');
            }, (error) => {
                console.error("Firestore Error:", error);
                showStatusMessage('データのロード中にエラーが発生しました。');
            });

            const sharedNotesDocPath = `/artifacts/${appId}/public/data/general_notes`;
            const sharedNotesDocRef = doc(db, sharedNotesDocPath, 'notes');
            onSnapshot(sharedNotesDocRef, (doc) => {
                if (doc.exists()) {
                    generalNotesData = doc.data();
                    goalDisplayEl.textContent = generalNotesData.goal || '目標を入力してください...';
                    issueDisplayEl.textContent = generalNotesData.issue || '課題点を入力してください...';
                } else {
                    generalNotesData = {};
                    goalDisplayEl.textContent = '目標を入力してください...';
                    issueDisplayEl.textContent = '課題点を入力してください...';
                }
                showStatusMessage('目標と課題点が更新されました');
            }, (error) => {
                console.error("Firestore Error:", error);
                showStatusMessage('データのロード中にエラーが発生しました。');
            });
        };

        const calendarEl = document.getElementById('calendar');
        const currentMonthYearEl = document.getElementById('currentMonthYear');
        const prevMonthBtn = document.getElementById('prevMonthBtn');
        const nextMonthBtn = document.getElementById('nextMonthBtn');
        const modalEl = document.getElementById('modal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const modalDateEl = document.getElementById('modalDate');
        const eventInput = document.getElementById('eventInput');
        const todoListEl = document.getElementById('todoList');
        const newTodoInput = document.getElementById('newTodoInput');
        const addTodoBtn = document.getElementById('addTodoBtn');
        const saveBtn = document.getElementById('saveBtn');
        const incompleteTodosEl = document.getElementById('incompleteTodos');

        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let selectedDate = null;
        
        let holidays = {};
        holidays['2025-01-01'] = '元日';
        holidays['2025-01-13'] = '成人の日';
        holidays['2025-02-11'] = '建国記念の日';
        holidays['2025-03-20'] = '春分の日';
        holidays['2025-04-29'] = '昭和の日';
        holidays['2025-05-03'] = '憲法記念日';
        holidays['2025-05-04'] = 'みどりの日';
        holidays['2025-05-05'] = 'こどもの日';
        holidays['2025-05-06'] = '振替休日';
        holidays['2025-07-21'] = '海の日';
        holidays['2025-08-11'] = '山の日';
        holidays['2025-08-15'] = '振替休日';
        holidays['2025-09-22'] = '敬老の日';
        holidays['2025-09-23'] = '秋分の日';
        holidays['2025-10-13'] = 'スポーツの日';
        holidays['2025-11-03'] = '文化の日';
        holidays['2025-11-23'] = '勤労感謝の日';
        holidays['2025-11-29'] = '振替休日';

        const generateDateKey = (year, month, day) => `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

        const renderCalendar = (year, month) => {
            calendarEl.innerHTML = '';
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const prevLastDay = new Date(year, month, 0);

            currentMonthYearEl.textContent = `${year}年 ${month + 1}月`;

            const startDayIndex = firstDay.getDay();

            for (let i = startDayIndex; i > 0; i--) {
                const day = prevLastDay.getDate() - i + 1;
                const cell = document.createElement('div');
                cell.classList.add('day-cell', 'prev-month', 'p-2');
                cell.innerHTML = `<span class="day-number">${day}</span>`;
                calendarEl.appendChild(cell);
            }

            for (let i = 1; i <= lastDay.getDate(); i++) {
                const date = new Date(year, month, i);
                const dateKey = generateDateKey(year, month, i);
                const storedData = eventData[dateKey] || { event: '', todos: [] };

                const cell = document.createElement('div');
                cell.classList.add('day-cell', 'p-2', 'relative');
                cell.dataset.date = dateKey;

                if (date.getDay() === 0 || holidays[dateKey]) {
                    cell.classList.add('holiday');
                }
                if (date.getDay() === 6) {
                    cell.classList.add('saturday');
                }
                if (date.toDateString() === new Date().toDateString()) {
                    cell.classList.add('today');
                }

                const daySpan = document.createElement('span');
                daySpan.classList.add('day-number');
                daySpan.textContent = i;
                cell.appendChild(daySpan);

                if (holidays[dateKey]) {
                    const holidayLabel = document.createElement('div');
                    holidayLabel.classList.add('event-item', 'bg-red-200', 'text-red-800');
                    holidayLabel.textContent = holidays[dateKey];
                    cell.appendChild(holidayLabel);
                }

                if (storedData.event) {
                    const eventDiv = document.createElement('div');
                    eventDiv.classList.add('event-item', 'mt-1', 'event');
                    if (storedData.color) {
                         eventDiv.style.backgroundColor = storedData.color + '40'; // 40は透明度
                         eventDiv.style.borderColor = storedData.color;
                    }
                    eventDiv.textContent = storedData.event;
                    cell.appendChild(eventDiv);
                }

                if (storedData.todos && storedData.todos.length > 0) {
                    storedData.todos.filter(todo => !todo.completed).forEach(todo => {
                        const todoDiv = document.createElement('div');
                        todoDiv.classList.add('event-item', 'mt-1', 'todo-item');
                        todoDiv.textContent = todo.text;
                        cell.appendChild(todoDiv);
                    });
                }
                
                cell.addEventListener('click', () => {
                    selectedDate = dateKey;
                    openModal(dateKey);
                });
                calendarEl.appendChild(cell);
            }

            const totalCells = startDayIndex + lastDay.getDate();
            const nextDays = 42 - totalCells;
            for (let i = 1; i <= nextDays; i++) {
                const cell = document.createElement('div');
                cell.classList.add('day-cell', 'next-month', 'p-2');
                cell.innerHTML = `<span class="day-number">${i}</span>`;
                calendarEl.appendChild(cell);
            }
        };

        const openModal = (dateKey) => {
            const storedData = eventData[dateKey] || { event: '', todos: [], color: '#e5e7eb' };
            modalDateEl.textContent = `${dateKey.replace(/-/g, '/')} の予定`;
            eventInput.value = storedData.event;
            eventColorInput.value = storedData.color || '#e5e7eb';
            renderTodos(storedData.todos);
            modalEl.classList.remove('hidden');
            modalEl.classList.add('flex');
        };

        const closeModal = () => {
            modalEl.classList.add('hidden');
            modalEl.classList.remove('flex');
            selectedDate = null;
        };
        
        const openNotesModal = (field) => {
            currentEditingField = field;
            notesModalTitleEl.textContent = field === 'goal' ? '目標の編集' : '課題点の編集';
            notesInputEl.value = generalNotesData[field] || '';
            notesModalEl.classList.remove('hidden');
            notesModalEl.classList.add('flex');
        };

        const closeNotesModal = () => {
            notesModalEl.classList.add('hidden');
            notesModalEl.classList.remove('flex');
            currentEditingField = null;
        };

        const renderTodos = (todos) => {
            todoListEl.innerHTML = '';
            if (!todos) return;
            todos.forEach((todo, index) => {
                const todoItem = document.createElement('div');
                todoItem.classList.add('flex', 'items-center', 'space-x-2', 'bg-gray-50', 'p-2', 'rounded');
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = todo.completed;
                checkbox.classList.add('form-checkbox', 'h-5', 'w-5', 'text-blue-600', 'rounded', 'cursor-pointer');
                checkbox.addEventListener('change', async () => {
                    const storedData = eventData[selectedDate] || { event: '', todos: [] };
                    storedData.todos[index].completed = checkbox.checked;
                    if (currentUserId) {
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                        const docRef = doc(db, `/artifacts/${appId}/public/data/calendar_events`, selectedDate);
                        await setDoc(docRef, storedData);
                        showStatusMessage(`TODO:「${todo.text}」の状態が変更されました。`);
                    } else {
                        renderTodos(storedData.todos);
                        renderIncompleteTodos();
                        showStatusMessage('ローカルモードでは変更が保存されません。');
                    }
                });

                const textSpan = document.createElement('span');
                textSpan.textContent = todo.text;
                textSpan.classList.add('flex-1', 'text-gray-700');
                if (todo.completed) {
                    textSpan.classList.add('line-through');
                }

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = '削除';
                deleteBtn.classList.add('bg-red-500', 'hover:bg-red-600', 'text-white', 'py-1', 'px-2', 'rounded', 'text-xs', 'transition-colors');
                deleteBtn.addEventListener('click', async () => {
                    const storedData = eventData[selectedDate] || { event: '', todos: [] };
                    storedData.todos.splice(index, 1);
                    if (currentUserId) {
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                        const docRef = doc(db, `/artifacts/${appId}/public/data/calendar_events`, selectedDate);
                        await setDoc(docRef, storedData);
                        showStatusMessage(`TODO:「${todo.text}」が削除されました。`);
                    } else {
                        renderTodos(storedData.todos);
                        renderIncompleteTodos();
                        showStatusMessage('ローカルモードでは変更が保存されません。');
                    }
                });

                todoItem.appendChild(checkbox);
                todoItem.appendChild(textSpan);
                todoItem.appendChild(deleteBtn);
                todoListEl.appendChild(todoItem);
            });
        };

        const renderIncompleteTodos = () => {
            incompleteTodosEl.innerHTML = '';
            const incompleteList = [];
            for (const dateKey in eventData) {
                const data = eventData[dateKey];
                if (data && data.todos) {
                    data.todos.filter(todo => !todo.completed).forEach(todo => {
                        incompleteList.push({
                            date: dateKey,
                            text: todo.text
                        });
                    });
                }
            }
            
            incompleteList.sort((a, b) => new Date(a.date) - new Date(b.date));

            if (incompleteList.length > 0) {
                incompleteList.forEach(item => {
                    const todoDiv = document.createElement('div');
                    todoDiv.classList.add('bg-blue-100', 'rounded-md', 'p-3', 'shadow-sm', 'text-gray-800', 'flex', 'items-center', 'space-x-2', 'incomplete-todo-item');
                    
                    const dateSpan = document.createElement('span');
                    dateSpan.classList.add('font-bold', 'flex-shrink-0');
                    dateSpan.textContent = `${item.date}:`;
                    
                    const textSpan = document.createElement('span');
                    textSpan.classList.add('flex-1');
                    textSpan.textContent = item.text;

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.classList.add('form-checkbox', 'h-5', 'w-5', 'text-blue-600', 'rounded', 'cursor-pointer', 'flex-shrink-0');
                    checkbox.addEventListener('change', async () => {
                        // 未完了リストからのチェックは、カレンダーの元のtodoを完了状態にする
                        const storedData = eventData[item.date] || { event: '', todos: [] };
                        const todoIndex = storedData.todos.findIndex(todo => todo.text === item.text);
                        if (todoIndex > -1) {
                            storedData.todos[todoIndex].completed = true;
                            if (currentUserId) {
                                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                                const docRef = doc(db, `/artifacts/${appId}/public/data/calendar_events`, item.date);
                                await setDoc(docRef, storedData);
                                showStatusMessage(`TODO:「${item.text}」が完了しました。`);
                            } else {
                                renderIncompleteTodos();
                            }
                        }
                    });

                    todoDiv.appendChild(checkbox);
                    todoDiv.appendChild(dateSpan);
                    todoDiv.appendChild(textSpan);
                    incompleteTodosEl.appendChild(todoDiv);
                });
            } else {
                incompleteTodosEl.innerHTML = '<p class="text-gray-500 text-center">未完了のやることリストはありません。</p>';
            }
        };

        const saveData = async () => {
            if (!selectedDate || !currentUserId) {
                showStatusMessage('ローカルモードでは変更が保存されません。');
                return;
            }
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const docRef = doc(db, `/artifacts/${appId}/public/data/calendar_events`, selectedDate);
            const storedData = eventData[selectedDate] || { event: '', todos: [] };
            storedData.event = eventInput.value;
            storedData.color = eventColorInput.value;
            await setDoc(docRef, storedData);
            showStatusMessage('予定が保存されました。');
        };

        const addTodo = async () => {
            const newTodoText = newTodoInput.value.trim();
            if (newTodoText === '' || !selectedDate || !currentUserId) {
                showStatusMessage('ローカルモードでは変更が保存されません。');
                return;
            }
            
            const storedData = eventData[selectedDate] || { event: '', todos: [] };
            const todoExists = storedData.todos.some(todo => todo.text.trim() === newTodoText);
            
            if (todoExists) {
                console.log('Duplicate todo item ignored.');
                newTodoInput.value = '';
                return;
            }

            storedData.todos.push({ text: newTodoText, completed: false });
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const docRef = doc(db, `/artifacts/${appId}/public/data/calendar_events`, selectedDate);
            await setDoc(docRef, storedData);
            renderTodos(storedData.todos);
            newTodoInput.value = '';
            showStatusMessage('やることリストに追加されました。');
        };
        
        const saveNotes = async () => {
            if (!currentUserId || !currentEditingField) {
                showStatusMessage('ローカルモードでは変更が保存されません。');
                return;
            }
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const notesDocRef = doc(db, `/artifacts/${appId}/public/data/general_notes`, 'notes');
            const updatedData = { ...generalNotesData, [currentEditingField]: notesInputEl.value };
            
            await setDoc(notesDocRef, updatedData);
            
            showStatusMessage('内容が保存されました。');
            closeNotesModal();
        };
        
        // イベントリスナー
        editGoalBtn.addEventListener('click', () => openNotesModal('goal'));
        editIssueBtn.addEventListener('click', () => openNotesModal('issue'));
        closeNotesModalBtn.addEventListener('click', closeNotesModal);
        cancelNotesBtn.addEventListener('click', closeNotesModal);
        saveNotesBtn.addEventListener('click', saveNotes);
        
        prevMonthBtn.addEventListener('click', () => {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar(currentYear, currentMonth);
        });

        nextMonthBtn.addEventListener('click', () => {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar(currentYear, currentMonth);
        });

        closeModalBtn.addEventListener('click', closeModal);
        saveBtn.addEventListener('click', () => {
            saveData();
            closeModal();
        });
        addTodoBtn.addEventListener('click', addTodo);
        newTodoInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                addTodo();
            }
        });

        authAndInit();
    </script>
</body>
</html>
