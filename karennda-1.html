<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }
        .day-cell {
            min-height: 120px;
            border: 1px solid #e5e7eb;
            padding: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
            background-color: white;
            overflow: hidden;
        }
        .day-cell.prev-month, .day-cell.next-month {
            color: #d1d5db;
        }
        .day-cell:not(.prev-month):not(.next-month):hover {
            background-color: #f9fafb;
        }
        .day-number {
            font-size: 1.5rem;
            font-weight: 600;
        }
        .day-cell.today {
            border: 2px solid #3b82f6;
        }
        .holiday {
            color: #ef4444;
        }
        .saturday {
            color: #3b82f6;
        }
        .event-item {
            font-size: 0.875rem;
            color: #4b5563;
            padding: 2px 4px;
            border-radius: 4px;
            margin-top: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .event-item.event {
            background-color: #e5e7eb;
        }
        .todo-item {
            font-size: 0.875rem;
            color: #4b5563;
            background-color: #d1fae5;
            padding: 2px 4px;
            border-radius: 4px;
            margin-top: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .todo-item.completed {
            text-decoration: line-through;
            background-color: #f3f4f6;
            color: #9ca3af;
        }
        .incomplete-todo-item {
            position: relative;
        }
        .main-container {
            max-width: 90%;
            padding: 1rem;
        }
        @media (min-width: 768px) {
            .main-container {
                max-width: 7xl;
                padding: 2rem;
            }
        }
        /* „Çπ„Éû„ÉõË°®Á§∫Áî®„ÅÆ„Çπ„Çø„Ç§„É´Ë™øÊï¥ */
        .mobile-layout .day-cell {
            min-height: 80px;
            padding: 4px;
        }
        .mobile-layout .day-number {
            font-size: 1rem;
        }
        .mobile-layout .event-item {
            font-size: 0.75rem;
        }
        .mobile-layout .text-2xl {
            font-size: 1.25rem;
        }
        .mobile-layout .text-3xl {
            font-size: 1.5rem;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">
    <div class="flex justify-center mb-4 space-x-4">
        <button id="mobileViewBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full transition-colors">„Çπ„Éû„ÉõË°®Á§∫</button>
        <button id="pcViewBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full transition-colors">PCË°®Á§∫</button>
    </div>
    <div id="appContainer" class="main-container mx-auto bg-white rounded-xl shadow-lg p-6 mb-8">
        <div class="flex items-center justify-between mb-6">
            <h1 class="text-3xl font-bold text-gray-800">2025Âπ¥ „Ç´„É¨„É≥„ÉÄ„Éº</h1>
            <div class="flex space-x-2">
                <button id="prevMonthBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-600 font-bold py-2 px-4 rounded-full transition-colors">&lt;</button>
                <span id="currentMonthYear" class="text-2xl font-semibold text-gray-700 self-center"></span>
                <button id="nextMonthBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-600 font-bold py-2 px-4 rounded-full transition-colors">&gt;</button>
            </div>
        </div>

        <div class="calendar-container rounded-lg overflow-hidden border border-gray-200">
            <div class="calendar-header calendar-grid text-center font-semibold bg-gray-200 text-gray-700 py-2">
                <div class="saturday">Êó•</div>
                <div>Êúà</div>
                <div>ÁÅ´</div>
                <div>Ê∞¥</div>
                <div>Êú®</div>
                <div>Èáë</div>
                <div class="holiday">Âúü</div>
            </div>
            <div id="calendar" class="calendar-grid">
                <!-- „Ç´„É¨„É≥„ÉÄ„Éº„ÅÆÊó•‰ªò„Åå„Åì„Åì„Å´ÁîüÊàê„Åï„Çå„Åæ„Åô -->
            </div>
        </div>
    </div>
    
    <!-- ÁõÆÊ®ô„Å®Ë™≤È°åÁÇπ -->
    <div class="main-container mx-auto bg-white rounded-xl shadow-lg p-6 mb-8">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold">ÁõÆÊ®ô</h2>
            <button id="editGoalBtn" class="bg-blue-500 hover:bg-blue-600 text-white py-1 px-4 rounded-full transition-colors">Á∑®ÈõÜ</button>
        </div>
        <div id="goalDisplay" class="p-4 rounded-lg bg-gray-50 whitespace-pre-wrap min-h-[10rem] text-gray-800"></div>

        <div class="flex justify-between items-center mt-6 mb-4">
            <h2 class="text-2xl font-bold">Ë™≤È°åÁÇπ</h2>
            <button id="editIssueBtn" class="bg-blue-500 hover:bg-blue-600 text-white py-1 px-4 rounded-full transition-colors">Á∑®ÈõÜ</button>
        </div>
        <div id="issueDisplay" class="p-4 rounded-lg bg-gray-50 whitespace-pre-wrap min-h-[10rem] text-gray-800"></div>
    </div>

    <!-- Êú™ÂÆå‰∫ÜTODO„É™„Çπ„Éà -->
    <div class="main-container mx-auto bg-white rounded-xl shadow-lg p-6 mb-8">
        <h2 class="text-2xl font-bold mb-4">Êú™ÂÆå‰∫Ü„ÅÆ„ÇÑ„Çã„Åì„Å®„É™„Çπ„Éà</h2>
        <div id="incompleteTodos" class="space-y-4">
            <!-- Êú™ÂÆå‰∫Ü„ÅÆTODO„É™„Çπ„Éà„Åå„Åì„Åì„Å´ÁîüÊàê„Åï„Çå„Åæ„Åô -->
        </div>
    </div>

    <!-- ÂÆå‰∫ÜÊ∏àTODO„É™„Çπ„Éà -->
    <div class="main-container mx-auto bg-white rounded-xl shadow-lg p-6 mb-8">
        <h2 class="text-2xl font-bold mb-4">ÂÆå‰∫ÜÊ∏à„Åø„ÅÆ„ÇÑ„Çã„Åì„Å®„É™„Çπ„Éà</h2>
        <div id="completedTodos" class="space-y-4">
            <!-- ÂÆå‰∫ÜÊ∏à„Åø„ÅÆTODO„É™„Çπ„Éà„Åå„Åì„Åì„Å´ÁîüÊàê„Åï„Çå„Åæ„Åô -->
        </div>
    </div>

    <!-- „Ç´„É¨„É≥„ÉÄ„ÉºÁî®„É¢„Éº„ÉÄ„É´„Ç¶„Ç£„É≥„Éâ„Ç¶ -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-xl">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modalDate" class="text-2xl font-bold"></h2>
                <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
            </div>
            
            <h3 class="text-lg font-semibold mb-2">‰∫àÂÆö</h3>
            <div class="flex items-center mb-4">
                <textarea id="eventInput" class="flex-1 h-24 p-2 border rounded resize-none focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="‰∫àÂÆö„ÇíÂÖ•Âäõ..."></textarea>
                <div class="ml-2 flex flex-col items-center">
                    <label for="eventColor" class="text-sm font-semibold text-gray-700">Ëâ≤</label>
                    <input type="color" id="eventColor" class="w-10 h-10 p-1 border rounded-md cursor-pointer">
                </div>
            </div>

            <h3 class="text-lg font-semibold mb-2">„ÇÑ„Çã„Åì„Å®„É™„Çπ„Éà</h3>
            <div id="todoList" class="space-y-2">
                <!-- TODO„É™„Çπ„Éà„ÅÆÈ†ÖÁõÆ„Åå„Åì„Åì„Å´ÁîüÊàê„Åï„Çå„Åæ„Åô -->
            </div>
            <div class="flex mt-4 space-x-2">
                <input type="text" id="newTodoInput" class="flex-1 p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Êñ∞„Åó„ÅÑ„ÇÑ„Çã„Åì„Å®...">
                <button id="addTodoBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition-colors">ËøΩÂä†</button>
            </div>
            <div class="flex justify-end mt-4">
                <button id="saveBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition-colors">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>

    <!-- ÁõÆÊ®ô„ÉªË™≤È°åÁÇπÁî®„É¢„Éº„ÉÄ„É´„Ç¶„Ç£„É≥„Éâ„Ç¶ -->
    <div id="notesModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-xl">
            <div class="flex justify-between items-center mb-4">
                <h2 id="notesModalTitle" class="text-2xl font-bold"></h2>
                <button id="closeNotesModalBtn" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
            </div>
            <textarea id="notesInput" class="w-full h-48 p-2 mb-4 border rounded resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
            <div class="flex justify-end mt-4 space-x-2">
                <button id="cancelNotesBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold py-2 px-4 rounded transition-colors">„Ç≠„É£„É≥„Çª„É´</button>
                <button id="saveNotesBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition-colors">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>
    
    <div id="statusMessage" class="fixed bottom-4 left-1/2 -translate-x-1/2 bg-gray-800 text-white text-sm py-2 px-4 rounded-full shadow-lg transition-opacity duration-300 opacity-0"></div>

    <div class="main-container mx-auto bg-white rounded-xl shadow-lg p-6 mt-8">
        <h2 class="text-xl font-semibold text-gray-600 mb-2">„É≠„Ç∞„Ç§„É≥‰∏≠„ÅÆ„É¶„Éº„Ç∂„ÉºID:</h2>
        <span id="userIdDisplay" class="font-mono bg-gray-200 text-gray-800 p-2 rounded-md block break-words"></span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD1as9zQr8P6k8Up9Y4FnO3DYroyvgMnAM",
            authDomain: "karennda-e8465.firebaseapp.com",
            projectId: "karennda-e8465",
            storageBucket: "karennda-e8465.firebasestorage.app",
            messagingSenderId: "1023443880200",
            appId: "1:1023443880200:web:ee995edd613fbc626544bd",
            measurementId: "G-E9Y0L9P95V"
        };
        
        let app = null;
        let db = null;
        let auth = null;
        
        if (firebaseConfig.projectId) {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (e) {
                console.error("Firebase initialization failed:", e);
            }
        } else {
            console.error("Firebase config is not available. Please add your config.");
        }

        const showStatusMessage = (message) => {
            const statusEl = document.getElementById('statusMessage');
            if (!statusEl) return;
            statusEl.textContent = message;
            statusEl.classList.remove('opacity-0');
            statusEl.classList.add('opacity-100');
            setTimeout(() => {
                statusEl.classList.remove('opacity-100');
                statusEl.classList.add('opacity-0');
            }, 3000);
        };

        let currentUserId = null;
        let eventData = {};
        let generalNotesData = {};
        let currentEditingField = null;
        const currentYearMonth = () => `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;

        const userIdDisplayEl = document.getElementById('userIdDisplay');
        const goalDisplayEl = document.getElementById('goalDisplay');
        const issueDisplayEl = document.getElementById('issueDisplay');
        const editGoalBtn = document.getElementById('editGoalBtn');
        const editIssueBtn = document.getElementById('editIssueBtn');
        const notesModalEl = document.getElementById('notesModal');
        const notesModalTitleEl = document.getElementById('notesModalTitle');
        const notesInputEl = document.getElementById('notesInput');
        const closeNotesModalBtn = document.getElementById('closeNotesModalBtn');
        const saveNotesBtn = document.getElementById('saveNotesBtn');
        const cancelNotesBtn = document.getElementById('cancelNotesBtn');
        const eventColorInput = document.getElementById('eventColor');
        const completedTodosEl = document.getElementById('completedTodos');
        const appContainerEl = document.getElementById('appContainer');
        const mobileViewBtn = document.getElementById('mobileViewBtn');
        const pcViewBtn = document.getElementById('pcViewBtn');

        const authAndInit = async () => {
            if (!auth || !db) {
                showStatusMessage('„É≠„Éº„Ç´„É´„É¢„Éº„Éâ„ÅßÂÆüË°å‰∏≠„ÄÇ„Éá„Éº„Çø„ÅØ‰øùÂ≠ò„Åï„Çå„Åæ„Åõ„Çì„ÄÇ');
                renderCalendar(currentYear, currentMonth);
                renderIncompleteTodos();
                renderCompletedTodos();
                return;
            }
            try {
                await signInAnonymously(auth);
                currentUserId = auth.currentUser.uid;
                userIdDisplayEl.textContent = currentUserId;
                showStatusMessage(`„É≠„Ç∞„Ç§„É≥„Åó„Åæ„Åó„Åü„ÄÇ„Éá„Éº„Çø„É≠„Éº„Éâ‰∏≠„Åß„Åô...`);
                initFirestoreListeners();
            } catch (error) {
                console.error("Firebase Authentication Error:", error);
                showStatusMessage('„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
            }
        };

        const initFirestoreListeners = () => {
            if (!currentUserId || !db) return;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            const sharedCalendarCollectionPath = `/artifacts/${appId}/public/data/calendar_events`;
            const sharedCalendarCollectionRef = collection(db, sharedCalendarCollectionPath);
            onSnapshot(sharedCalendarCollectionRef, (snapshot) => {
                const newEventData = {};
                snapshot.forEach((doc) => {
                    newEventData[doc.id] = doc.data();
                });
                eventData = newEventData;
                renderCalendar(currentYear, currentMonth);
                renderIncompleteTodos();
                renderCompletedTodos();
                showStatusMessage('„Ç´„É¨„É≥„ÉÄ„Éº„Éá„Éº„Çø„ÅåÊõ¥Êñ∞„Åï„Çå„Åæ„Åó„Åü');
            }, (error) => {
                console.error("Firestore Error:", error);
                showStatusMessage('„Éá„Éº„Çø„ÅÆ„É≠„Éº„Éâ‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ');
            });

            const sharedNotesDocPath = `/artifacts/${appId}/public/data/monthly_notes/${currentYearMonth()}`;
            const sharedNotesDocRef = doc(db, sharedNotesDocPath);
            onSnapshot(sharedNotesDocRef, (doc) => {
                if (doc.exists()) {
                    generalNotesData = doc.data();
                    goalDisplayEl.textContent = generalNotesData.goal || 'ÁõÆÊ®ô„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ...';
                    issueDisplayEl.textContent = generalNotesData.issue || 'Ë™≤È°åÁÇπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ...';
                } else {
                    generalNotesData = {};
                    goalDisplayEl.textContent = 'ÁõÆÊ®ô„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ...';
                    issueDisplayEl.textContent = 'Ë™≤È°åÁÇπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ...';
                }
                showStatusMessage('ÁõÆÊ®ô„Å®Ë™≤È°åÁÇπ„ÅåÊõ¥Êñ∞„Åï„Çå„Åæ„Åó„Åü');
            }, (error) => {
                console.error("Firestore Error:", error);
                showStatusMessage('„Éá„Éº„Çø„ÅÆ„É≠„Éº„Éâ‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ');
            });
        };

        const calendarEl = document.getElementById('calendar');
        const currentMonthYearEl = document.getElementById('currentMonthYear');
        const prevMonthBtn = document.getElementById('prevMonthBtn');
        const nextMonthBtn = document.getElementById('nextMonthBtn');
        const modalEl = document.getElementById('modal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const modalDateEl = document.getElementById('modalDate');
        const eventInput = document.getElementById('eventInput');
        const todoListEl = document.getElementById('todoList');
        const newTodoInput = document.getElementById('newTodoInput');
        const addTodoBtn = document.getElementById('addTodoBtn');
        const saveBtn = document.getElementById('saveBtn');
        const incompleteTodosEl = document.getElementById('incompleteTodos');

        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let selectedDate = null;
        
        let holidays = {};
        holidays['2025-01-01'] = 'ÂÖÉÊó•';
        holidays['2025-01-13'] = 'Êàê‰∫∫„ÅÆÊó•';
        holidays['2025-02-11'] = 'Âª∫ÂõΩË®òÂøµ„ÅÆÊó•';
        holidays['2025-03-20'] = 'Êò•ÂàÜ„ÅÆÊó•';
        holidays['2025-04-29'] = 'Êò≠Âíå„ÅÆÊó•';
        holidays['2025-05-03'] = 'ÊÜ≤Ê≥ïË®òÂøµÊó•';
        holidays['2025-05-04'] = '„Åø„Å©„Çä„ÅÆÊó•';
        holidays['2025-05-05'] = '„Åì„Å©„ÇÇ„ÅÆÊó•';
        holidays['2025-05-06'] = 'ÊåØÊõø‰ºëÊó•';
        holidays['2025-07-21'] = 'Êµ∑„ÅÆÊó•';
        holidays['2025-08-11'] = 'Â±±„ÅÆÊó•';
        holidays['2025-08-15'] = 'ÊåØÊõø‰ºëÊó•';
        holidays['2025-09-22'] = 'Êï¨ËÄÅ„ÅÆÊó•';
        holidays['2025-09-23'] = 'ÁßãÂàÜ„ÅÆÊó•';
        holidays['2025-10-13'] = '„Çπ„Éù„Éº„ÉÑ„ÅÆÊó•';
        holidays['2025-11-03'] = 'ÊñáÂåñ„ÅÆÊó•';
        holidays['2025-11-23'] = 'Âã§Âä¥ÊÑüË¨ù„ÅÆÊó•';
        holidays['2025-11-29'] = 'ÊåØÊõø‰ºëÊó•';

        const generateDateKey = (year, month, day) => `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

        const renderCalendar = (year, month) => {
            calendarEl.innerHTML = '';
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const prevLastDay = new Date(year, month, 0);

            currentMonthYearEl.textContent = `${year}Âπ¥ ${month + 1}Êúà`;

            const startDayIndex = firstDay.getDay();

            for (let i = startDayIndex; i > 0; i--) {
                const day = prevLastDay.getDate() - i + 1;
                const cell = document.createElement('div');
                cell.classList.add('day-cell', 'prev-month', 'p-2');
                cell.innerHTML = `<span class="day-number">${day}</span>`;
                calendarEl.appendChild(cell);
            }

            for (let i = 1; i <= lastDay.getDate(); i++) {
                const date = new Date(year, month, i);
                const dateKey = generateDateKey(year, month, i);
                const storedData = eventData[dateKey] || { event: '', todos: [] };

                const cell = document.createElement('div');
                cell.classList.add('day-cell', 'p-2', 'relative');
                cell.dataset.date = dateKey;

                if (date.getDay() === 0 || holidays[dateKey]) {
                    cell.classList.add('holiday');
                }
                if (date.getDay() === 6) {
                    cell.classList.add('saturday');
                }
                if (date.toDateString() === new Date().toDateString()) {
                    cell.classList.add('today');
                }

                const daySpan = document.createElement('span');
                daySpan.classList.add('day-number');
                daySpan.textContent = i;
                cell.appendChild(daySpan);

                if (holidays[dateKey]) {
                    const holidayLabel = document.createElement('div');
                    holidayLabel.classList.add('event-item', 'bg-red-200', 'text-red-800');
                    holidayLabel.textContent = holidays[dateKey];
                    cell.appendChild(holidayLabel);
                }

                if (storedData.event) {
                    const eventDiv = document.createElement('div');
                    eventDiv.classList.add('event-item', 'mt-1', 'event');
                    if (storedData.color) {
                         eventDiv.style.backgroundColor = storedData.color + '40'; // 40„ÅØÈÄèÊòéÂ∫¶
                         eventDiv.style.borderColor = storedData.color;
                    }
                    eventDiv.textContent = storedData.event;
                    cell.appendChild(eventDiv);
                }

                if (storedData.todos && storedData.todos.length > 0) {
                    storedData.todos.filter(todo => !todo.completed).forEach(todo => {
                        const todoDiv = document.createElement('div');
                        todoDiv.classList.add('event-item', 'mt-1', 'todo-item');
                        todoDiv.textContent = `„Éª ${todo.text}`;
                        cell.appendChild(todoDiv);
                    });
                }
                
                cell.addEventListener('click', () => {
                    selectedDate = dateKey;
                    openModal(dateKey);
                });
                calendarEl.appendChild(cell);
            }

            const totalCells = startDayIndex + lastDay.getDate();
            const nextDays = 42 - totalCells;
            for (let i = 1; i <= nextDays; i++) {
                const cell = document.createElement('div');
                cell.classList.add('day-cell', 'next-month', 'p-2');
                cell.innerHTML = `<span class="day-number">${i}</span>`;
                calendarEl.appendChild(cell);
            }
        };

        const openModal = (dateKey) => {
            const storedData = eventData[dateKey] || { event: '', todos: [], color: '#e5e7eb' };
            modalDateEl.textContent = `${dateKey.replace(/-/g, '/')} „ÅÆ‰∫àÂÆö`;
            eventInput.value = storedData.event;
            eventColorInput.value = storedData.color || '#e5e7eb';
            renderTodos(storedData.todos);
            modalEl.classList.remove('hidden');
            modalEl.classList.add('flex');
        };

        const closeModal = () => {
            modalEl.classList.add('hidden');
            modalEl.classList.remove('flex');
            selectedDate = null;
        };
        
        const openNotesModal = (field) => {
            currentEditingField = field;
            notesModalTitleEl.textContent = field === 'goal' ? 'ÁõÆÊ®ô„ÅÆÁ∑®ÈõÜ' : 'Ë™≤È°åÁÇπ„ÅÆÁ∑®ÈõÜ';
            notesInputEl.value = generalNotesData[field] || '';
            notesModalEl.classList.remove('hidden');
            notesModalEl.classList.add('flex');
        };

        const closeNotesModal = () => {
            notesModalEl.classList.add('hidden');
            notesModalEl.classList.remove('flex');
            currentEditingField = null;
        };

        const renderTodos = (todos) => {
            todoListEl.innerHTML = '';
            if (!todos) return;
            todos.forEach((todo, index) => {
                const todoItem = document.createElement('div');
                todoItem.classList.add('flex', 'items-center', 'space-x-2', 'bg-gray-50', 'p-2', 'rounded');
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = todo.completed;
                checkbox.classList.add('form-checkbox', 'h-5', 'w-5', 'text-blue-600', 'rounded', 'cursor-pointer');
                checkbox.addEventListener('change', async () => {
                    const storedData = eventData[selectedDate] || { event: '', todos: [] };
                    storedData.todos[index].completed = checkbox.checked;
                    if (currentUserId) {
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                        const docRef = doc(db, `/artifacts/${appId}/public/data/calendar_events`, selectedDate);
                        await setDoc(docRef, storedData);
                        showStatusMessage(`TODO:„Äå${todo.text}„Äç„ÅÆÁä∂ÊÖã„ÅåÂ§âÊõ¥„Åï„Çå„Åæ„Åó„Åü„ÄÇ`);
                    } else {
                        renderTodos(storedData.todos);
                        renderIncompleteTodos();
                        showStatusMessage('„É≠„Éº„Ç´„É´„É¢„Éº„Éâ„Åß„ÅØÂ§âÊõ¥„Åå‰øùÂ≠ò„Åï„Çå„Åæ„Åõ„Çì„ÄÇ');
                    }
                });

                const textSpan = document.createElement('span');
                textSpan.textContent = todo.text;
                textSpan.classList.add('flex-1', 'text-gray-700');
                if (todo.completed) {
                    textSpan.classList.add('line-through');
                }

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'ÂâäÈô§';
                deleteBtn.classList.add('bg-red-500', 'hover:bg-red-600', 'text-white', 'py-1', 'px-2', 'rounded', 'text-xs', 'transition-colors');
                deleteBtn.addEventListener('click', async () => {
                    const storedData = eventData[selectedDate] || { event: '', todos: [] };
                    storedData.todos.splice(index, 1);
                    if (currentUserId) {
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                        const docRef = doc(db, `/artifacts/${appId}/public/data/calendar_events`, selectedDate);
                        await setDoc(docRef, storedData);
                        showStatusMessage(`TODO:„Äå${todo.text}„Äç„ÅåÂâäÈô§„Åï„Çå„Åæ„Åó„Åü„ÄÇ`);
                    } else {
                        renderTodos(storedData.todos);
                        renderIncompleteTodos();
                        showStatusMessage('„É≠„Éº„Ç´„É´„É¢„Éº„Éâ„Åß„ÅØÂ§âÊõ¥„Åå‰øùÂ≠ò„Åï„Çå„Åæ„Åõ„Çì„ÄÇ');
                    }
                });

                todoItem.appendChild(checkbox);
                todoItem.appendChild(textSpan);
                todoItem.appendChild(deleteBtn);
                todoListEl.appendChild(todoItem);
            });
        };

        const renderIncompleteTodos = () => {
            incompleteTodosEl.innerHTML = '';
            const incompleteList = [];
            for (const dateKey in eventData) {
                const data = eventData[dateKey];
                const parts = dateKey.split('-');
                if (data && data.todos) {
                    data.todos.filter(todo => !todo.completed).forEach(todo => {
                        incompleteList.push({
                            date: dateKey, //Êó•‰ªòÂÖ®‰Ωì„ÇíÊ∏°„Åô
                            day: parts[2], // Êó•„Å†„Åë„ÇíÂèñÂæó
                            text: todo.text
                        });
                    });
                }
            }
            
            incompleteList.sort((a, b) => new Date(a.date) - new Date(b.date));

            if (incompleteList.length > 0) {
                incompleteList.forEach(item => {
                    const todoDiv = document.createElement('div');
                    todoDiv.classList.add('bg-blue-100', 'rounded-md', 'p-3', 'shadow-sm', 'text-gray-800', 'flex', 'items-center', 'space-x-2', 'incomplete-todo-item');
                    
                    const dateSpan = document.createElement('span');
                    dateSpan.classList.add('font-bold', 'flex-shrink-0');
                    dateSpan.textContent = `${item.day}Êó•:`;
                    
                    const textSpan = document.createElement('span');
                    textSpan.classList.add('flex-1');
                    textSpan.textContent = item.text;

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.classList.add('form-checkbox', 'h-5', 'w-5', 'text-blue-600', 'rounded', 'cursor-pointer', 'flex-shrink-0');
                    checkbox.addEventListener('change', async () => {
                         const storedData = eventData[item.date] || { event: '', todos: [] };
                         const todoIndex = storedData.todos.findIndex(todo => todo.text === item.text);
                         if (todoIndex > -1) {
                             storedData.todos[todoIndex].completed = true;
                             if (currentUserId) {
                                 const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                                 const docRef = doc(db, `/artifacts/${appId}/public/data/calendar_events`, item.date);
                                 await setDoc(docRef, storedData);
                                 showStatusMessage(`TODO:„Äå${item.text}„Äç„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ`);
                             } else {
                                 renderIncompleteTodos();
                             }
                         }
                    });

                    todoDiv.appendChild(checkbox);
                    todoDiv.appendChild(dateSpan);
                    todoDiv.appendChild(textSpan);
                    incompleteTodosEl.appendChild(todoDiv);
                });
            } else {
                incompleteTodosEl.innerHTML = '<p class="text-gray-500 text-center">Êú™ÂÆå‰∫Ü„ÅÆ„ÇÑ„Çã„Åì„Å®„É™„Çπ„Éà„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>';
            }
        };

        const renderCompletedTodos = () => {
            completedTodosEl.innerHTML = '';
            const completedList = [];
            for (const dateKey in eventData) {
                const data = eventData[dateKey];
                const parts = dateKey.split('-');
                if (data && data.todos) {
                    data.todos.filter(todo => todo.completed).forEach(todo => {
                        completedList.push({
                            date: dateKey, //Êó•‰ªòÂÖ®‰Ωì„ÇíÊ∏°„Åô
                            day: parts[2], // Êó•„Å†„Åë„ÇíÂèñÂæó
                            text: todo.text
                        });
                    });
                }
            }

            completedList.sort((a, b) => new Date(a.date) - new Date(b.date));

            if (completedList.length > 0) {
                completedList.forEach(item => {
                    const todoDiv = document.createElement('div');
                    todoDiv.classList.add('bg-gray-200', 'rounded-md', 'p-3', 'shadow-sm', 'text-gray-600', 'flex', 'items-center', 'space-x-2', 'incomplete-todo-item');
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = true;
                    checkbox.classList.add('form-checkbox', 'h-5', 'w-5', 'text-green-600', 'rounded', 'cursor-pointer', 'flex-shrink-0');
                    checkbox.addEventListener('change', async () => {
                        const storedData = eventData[item.date] || { event: '', todos: [] };
                        const todoIndex = storedData.todos.findIndex(todo => todo.text === item.text);
                        if (todoIndex > -1) {
                            storedData.todos[todoIndex].completed = false;
                            if (currentUserId) {
                                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                                const docRef = doc(db, `/artifacts/${appId}/public/data/calendar_events`, item.date);
                                await setDoc(docRef, storedData);
                                showStatusMessage(`TODO:„Äå${item.text}„Äç„ÅåÊú™ÂÆå‰∫Ü„Å´Êàª„Åï„Çå„Åæ„Åó„Åü„ÄÇ`);
                            } else {
                                renderCompletedTodos();
                            }
                        }
                    });

                    const dateSpan = document.createElement('span');
                    dateSpan.classList.add('font-bold', 'flex-shrink-0');
                    dateSpan.textContent = `${item.day}Êó•:`;
                    
                    const textSpan = document.createElement('span');
                    textSpan.classList.add('flex-1', 'line-through');
                    textSpan.textContent = item.text;

                    todoDiv.appendChild(checkbox);
                    todoDiv.appendChild(dateSpan);
                    todoDiv.appendChild(textSpan);
                    completedTodosEl.appendChild(todoDiv);
                });
            } else {
                completedTodosEl.innerHTML = '<p class="text-gray-500 text-center">ÂÆå‰∫ÜÊ∏à„Åø„ÅÆ„ÇÑ„Çã„Åì„Å®„É™„Çπ„Éà„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>';
            }
        };

        const saveData = async () => {
            if (!selectedDate || !currentUserId) {
                showStatusMessage('„É≠„Éº„Ç´„É´„É¢„Éº„Éâ„Åß„ÅØÂ§âÊõ¥„Åå‰øùÂ≠ò„Åï„Çå„Åæ„Åõ„Çì„ÄÇ');
                return;
            }
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const docRef = doc(db, `/artifacts/${appId}/public/data/calendar_events`, selectedDate);
            const storedData = eventData[selectedDate] || { event: '', todos: [] };
            storedData.event = eventInput.value;
            storedData.color = eventColorInput.value;
            await setDoc(docRef, storedData);
            showStatusMessage('‰∫àÂÆö„Åå‰øùÂ≠ò„Åï„Çå„Åæ„Åó„Åü„ÄÇ');
        };

        const addTodo = async () => {
            const newTodoText = newTodoInput.value.trim();
            if (newTodoText === '' || !selectedDate || !currentUserId) {
                showStatusMessage('„É≠„Éº„Ç´„É´„É¢„Éº„Éâ„Åß„ÅØÂ§âÊõ¥„Åå‰øùÂ≠ò„Åï„Çå„Åæ„Åõ„Çì„ÄÇ');
                return;
            }
            
            const storedData = eventData[selectedDate] || { event: '', todos: [] };
            const todoExists = storedData.todos.some(todo => todo.text.trim() === newTodoText);
            
            if (todoExists) {
                console.log('Duplicate todo item ignored.');
                newTodoInput.value = '';
                return;
            }

            storedData.todos.push({ text: newTodoText, completed: false });
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const docRef = doc(db, `/artifacts/${appId}/public/data/calendar_events`, selectedDate);
            await setDoc(docRef, storedData);
            renderTodos(storedData.todos);
            newTodoInput.value = '';
            showStatusMessage('„ÇÑ„Çã„Åì„Å®„É™„Çπ„Éà„Å´ËøΩÂä†„Åï„Çå„Åæ„Åó„Åü„ÄÇ');
        };
        
        const saveNotes = async () => {
            if (!currentUserId || !currentEditingField) {
                showStatusMessage('„É≠„Éº„Ç´„É´„É¢„Éº„Éâ„Åß„ÅØÂ§âÊõ¥„Åå‰øùÂ≠ò„Åï„Çå„Åæ„Åõ„Çì„ÄÇ');
                return;
            }
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const notesDocRef = doc(db, `/artifacts/${appId}/public/data/monthly_notes/${currentYearMonth()}`, 'notes');
            const updatedData = { ...generalNotesData, [currentEditingField]: notesInputEl.value };
            
            await setDoc(notesDocRef, updatedData);
            
            showStatusMessage('ÂÜÖÂÆπ„Åå‰øùÂ≠ò„Åï„Çå„Åæ„Åó„Åü„ÄÇ');
            closeNotesModal();
        };

        const applyMobileStyles = () => {
            document.body.classList.add('mobile-layout');
            document.body.classList.remove('pc-layout');
            appContainerEl.classList.remove('max-w-7xl');
            appContainerEl.classList.add('max-w-md');
        };

        const applyPcStyles = () => {
            document.body.classList.remove('mobile-layout');
            document.body.classList.add('pc-layout');
            appContainerEl.classList.remove('max-w-md');
            appContainerEl.classList.add('max-w-7xl');
        };
        
        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        editGoalBtn.addEventListener('click', () => openNotesModal('goal'));
        editIssueBtn.addEventListener('click', () => openNotesModal('issue'));
        closeNotesModalBtn.addEventListener('click', closeNotesModal);
        cancelNotesBtn.addEventListener('click', closeNotesModal);
        saveNotesBtn.addEventListener('click', saveNotes);
        
        prevMonthBtn.addEventListener('click', () => {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            initFirestoreListeners();
            renderCalendar(currentYear, currentMonth);
        });

        nextMonthBtn.addEventListener('click', () => {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            initFirestoreListeners();
            renderCalendar(currentYear, currentMonth);
        });

        closeModalBtn.addEventListener('click', closeModal);
        saveBtn.addEventListener('click', () => {
            saveData();
            closeModal();
        });
        addTodoBtn.addEventListener('click', addTodo);
        newTodoInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                addTodo();
            }
        });

        mobileViewBtn.addEventListener('click', applyMobileStyles);
        pcViewBtn.addEventListener('click', applyPcStyles);

        authAndInit();
    </script>
</body>
</html>
