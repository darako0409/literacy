<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ»</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }
        .day-cell {
            min-height: 120px;
            border: 1px solid #e5e7eb;
            padding: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
            background-color: white;
            overflow: hidden;
        }
        .day-cell.prev-month, .day-cell.next-month {
            color: #d1d5db;
        }
        .day-cell:not(.prev-month):not(.next-month):hover {
            background-color: #f9fafb;
        }
        .day-number {
            font-size: 1.5rem;
            font-weight: 600;
        }
        .day-cell.today {
            border: 2px solid #3b82f6;
        }
        .holiday {
            color: #ef4444;
        }
        .saturday {
            color: #3b82f6;
        }
        .event-item {
            font-size: 0.875rem;
            color: #4b5563;
            padding: 2px 4px;
            border-radius: 4px;
            margin-top: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .event-item.event {
            background-color: #e5e7eb;
        }
        .todo-item {
            font-size: 0.875rem;
            color: #4b5563;
            background-color: #d1fae5;
            padding: 2px 4px;
            border-radius: 4px;
            margin-top: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .todo-item.completed {
            text-decoration: line-through;
            background-color: #f3f4f6;
            color: #9ca3af;
        }
        .incomplete-todo-item {
            position: relative;
        }
        .main-container {
            max-width: 90%;
            padding: 1rem;
        }
        @media (min-width: 768px) {
            .main-container {
                max-width: 7xl;
                padding: 2rem;
            }
        }
        /* ã‚¹ãƒãƒ›è¡¨ç¤ºç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
        .mobile-layout .day-cell {
            min-height: 80px;
            padding: 4px;
        }
        .mobile-layout .day-number {
            font-size: 1rem;
        }
        .mobile-layout .event-item {
            font-size: 0.75rem;
        }
        .mobile-layout .text-2xl {
            font-size: 1.25rem;
        }
        .mobile-layout .text-3xl {
            font-size: 1.5rem;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">
    <div class="flex justify-center mb-4 space-x-4">
        <button id="mobileViewBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full transition-colors">ã‚¹ãƒãƒ›è¡¨ç¤º</button>
        <button id="pcViewBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full transition-colors">PCè¡¨ç¤º</button>
    </div>
    <div id="appContainer" class="main-container mx-auto bg-white rounded-xl shadow-lg p-6 mb-8">
        <div class="flex items-center justify-between mb-6">
            <h1 class="text-3xl font-bold text-gray-800">ğŸŒ»</h1>
            <div class="flex space-x-2">
                <button id="prevMonthBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-600 font-bold py-2 px-4 rounded-full transition-colors">&lt;</button>
                <span id="currentMonthYear" class="text-2xl font-semibold text-gray-700 self-center"></span>
                <button id="nextMonthBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-600 font-bold py-2 px-4 rounded-full transition-colors">&gt;</button>
            </div>
        </div>

        <div class="calendar-container rounded-lg overflow-hidden border border-gray-200">
            <div class="calendar-header calendar-grid text-center font-semibold bg-gray-200 text-gray-700 py-2">
                <div class="saturday">æ—¥</div>
                <div>æœˆ</div>
                <div>ç«</div>
                <div>æ°´</div>
                <div>æœ¨</div>
                <div>é‡‘</div>
                <div class="holiday">åœŸ</div>
            </div>
            <div id="calendar" class="calendar-grid">
                <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ—¥ä»˜ãŒã“ã“ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
            </div>
        </div>
    </div>
    
    <!-- ç›®æ¨™ã¨èª²é¡Œç‚¹ -->
    <div class="main-container mx-auto bg-white rounded-xl shadow-lg p-6 mb-8">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold">ç›®æ¨™</h2>
            <button id="editGoalBtn" class="bg-blue-500 hover:bg-blue-600 text-white py-1 px-4 rounded-full transition-colors">ç·¨é›†</button>
        </div>
        <div id="goalDisplay" class="p-4 rounded-lg bg-gray-50 whitespace-pre-wrap min-h-[10rem] text-gray-800"></div>

        <div class="flex justify-between items-center mt-6 mb-4">
            <h2 class="text-2xl font-bold">èª²é¡Œç‚¹</h2>
            <button id="editIssueBtn" class="bg-blue-500 hover:bg-blue-600 text-white py-1 px-4 rounded-full transition-colors">ç·¨é›†</button>
        </div>
        <div id="issueDisplay" class="p-4 rounded-lg bg-gray-50 whitespace-pre-wrap min-h-[10rem] text-gray-800"></div>
    </div>

    <!-- æœªå®Œäº†TODOãƒªã‚¹ãƒˆ -->
    <div class="main-container mx-auto bg-white rounded-xl shadow-lg p-6 mb-8">
        <h2 class="text-2xl font-bold mb-4">æœªå®Œäº†ã®ã‚„ã‚‹ã“ã¨ãƒªã‚¹ãƒˆ</h2>
        <div id="incompleteTodos" class="space-y-4">
            <!-- æœªå®Œäº†ã®TODOãƒªã‚¹ãƒˆãŒã“ã“ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
        </div>
    </div>

    <!-- å®Œäº†æ¸ˆTODOãƒªã‚¹ãƒˆ -->
    <div class="main-container mx-auto bg-white rounded-xl shadow-lg p-6 mb-8">
        <h2 class="text-2xl font-bold mb-4">å®Œäº†æ¸ˆã¿ã®ã‚„ã‚‹ã“ã¨ãƒªã‚¹ãƒˆ</h2>
        <div id="completedTodos" class="space-y-4">
            <!-- å®Œäº†æ¸ˆã¿ã®TODOãƒªã‚¹ãƒˆãŒã“ã“ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
        </div>
    </div>

    <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-xl">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modalDate" class="text-2xl font-bold"></h2>
                <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
            </div>
            
            <h3 class="text-lg font-semibold mb-2">äºˆå®š</h3>
            <div class="flex items-center mb-4">
                <textarea id="eventInput" class="flex-1 h-24 p-2 border rounded resize-none focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="äºˆå®šã‚’å…¥åŠ›..."></textarea>
                <div class="ml-2 flex flex-col items-center">
                    <label for="eventColor" class="text-sm font-semibold text-gray-700">è‰²</label>
                    <input type="color" id="eventColor" class="w-10 h-10 p-1 border rounded-md cursor-pointer">
                </div>
            </div>

            <h3 class="text-lg font-semibold mb-2">ã‚„ã‚‹ã“ã¨ãƒªã‚¹ãƒˆ</h3>
            <div id="todoList" class="space-y-2">
                <!-- TODOãƒªã‚¹ãƒˆã®é …ç›®ãŒã“ã“ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
            </div>
            <div class="flex mt-4 space-x-2">
                <input type="text" id="newTodoInput" class="flex-1 p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="æ–°ã—ã„ã‚„ã‚‹ã“ã¨...">
                <button id="addTodoBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition-colors">è¿½åŠ </button>
            </div>
            <div class="flex justify-end mt-4">
                <button id="saveBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition-colors">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- ç›®æ¨™ãƒ»èª²é¡Œç‚¹ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ -->
    <div id="notesModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-xl">
            <div class="flex justify-between items-center mb-4">
                <h2 id="notesModalTitle" class="text-2xl font-bold"></h2>
                <button id="closeNotesModalBtn" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
            </div>
            <textarea id="notesInput" class="w-full h-48 p-2 mb-4 border rounded resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
            <div class="flex justify-end mt-4 space-x-2">
                <button id="cancelNotesBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold py-2 px-4 rounded transition-colors">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="saveNotesBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition-colors">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <div id="statusMessage" class="fixed bottom-4 left-1/2 -translate-x-1/2 bg-gray-800 text-white text-sm py-2 px-4 rounded-full shadow-lg transition-opacity duration-300 opacity-0"></div>

    <div class="main-container mx-auto bg-white rounded-xl shadow-lg p-6 mt-8">
        <h2 class="text-xl font-semibold text-gray-600 mb-2">ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:</h2>
        <span id="userIdDisplay" class="font-mono bg-gray-200 text-gray-800 p-2 rounded-md block break-words"></span>
    </div>

    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { firebaseConfig } from "./config.js";
        
        let app = null;
        let db = null;
        let auth = null;
        
        if (firebaseConfig.projectId) {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (e) {
                console.error("Firebase initialization failed:", e);
            }
        } else {
            console.error("Firebase config is not available. Please add your config.");
        }

        const showStatusMessage = (message) => {
            const statusEl = document.getElementById('statusMessage');
            if (!statusEl) return;
            statusEl.textContent = message;
            statusEl.classList.remove('opacity-0');
            statusEl.classList.add('opacity-100');
            setTimeout(() => {
                statusEl.classList.remove('opacity-100');
                statusEl.classList.add('opacity-0');
            }, 3000);
        };

        let currentUserId = null;
        let eventData = {};
        let generalNotesData = {};
        let currentEditingField = null;
        const currentYearMonth = () => `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;

        const userIdDisplayEl = document.getElementById('userIdDisplay');
        const goalDisplayEl = document.getElementById('goalDisplay');
        const issueDisplayEl = document.getElementById('issueDisplay');
        const editGoalBtn = document.getElementById('editGoalBtn');
        const editIssueBtn = document.getElementById('editIssueBtn');
        const notesModalEl = document.getElementById('notesModal');
        const notesModalTitleEl = document.getElementById('notesModalTitle');
        const notesInputEl = document.getElementById('notesInput');
        const closeNotesModalBtn = document.getElementById('closeNotesModalBtn');
        const saveNotesBtn = document.getElementById('saveNotesBtn');
        const cancelNotesBtn = document.getElementById('cancelNotesBtn');
        const eventColorInput = document.getElementById('eventColor');
        const completedTodosEl = document.getElementById('completedTodos');
        const appContainerEl = document.getElementById('appContainer');
        const mobileViewBtn = document.getElementById('mobileViewBtn');
        const pcViewBtn = document.getElementById('pcViewBtn');

        const authAndInit = async () => {
            if (!auth || !db) {
                showStatusMessage('ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œä¸­ã€‚ãƒ‡ãƒ¼ã‚¿ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚');
                renderCalendar(currentYear, currentMonth);
                renderIncompleteTodos();
                renderCompletedTodos();
                return;
            }
            try {
                await signInAnonymously(auth);
                currentUserId = auth.currentUser.uid;
                userIdDisplayEl.textContent = currentUserId;
                showStatusMessage(`ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ä¸­ã§ã™...`);
                initFirestoreListeners();
            } catch (error) {
                console.error("Firebase Authentication Error:", error);
                showStatusMessage('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        };

        const initFirestoreListeners = () => {
            if (!currentUserId || !db) return;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            const sharedCalendarCollectionPath = `/artifacts/${appId}/public/data/calendar_events`;
            const sharedCalendarCollectionRef = collection(db, sharedCalendarCollectionPath);
            onSnapshot(sharedCalendarCollectionRef, (snapshot) => {
                const newEventData = {};
                snapshot.forEach((doc) => {
                    newEventData[doc.id] = doc.data();
                });
                eventData = newEventData;
                renderCalendar(currentYear, currentMonth);
                renderIncompleteTodos();
                renderCompletedTodos();
                showStatusMessage('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ');
            }, (error) => {
                console.error("Firestore Error:", error);
                showStatusMessage('ãƒ‡ãƒ¼ã‚¿ã®ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
            });

            const sharedNotesDocPath = `/artifacts/${appId}/public/data/monthly_notes`;
            const sharedNotesDocRef = doc(db, sharedNotesDocPath, currentYearMonth());
            onSnapshot(sharedNotesDocRef, (doc) => {
                if (doc.exists()) {
                    generalNotesData = doc.data();
                    goalDisplayEl.textContent = generalNotesData.goal || 'ç›®æ¨™ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...';
                    issueDisplayEl.textContent = generalNotesData.issue || 'èª²é¡Œç‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...';
                } else {
                    generalNotesData = {};
                    goalDisplayEl.textContent = 'ç›®æ¨™ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...';
                    issueDisplayEl.textContent = 'èª²é¡Œç‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...';
                }
                showStatusMessage('ç›®æ¨™ã¨èª²é¡Œç‚¹ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ');
            }, (error) => {
                console.error("Firestore Error:", error);
                showStatusMessage('ãƒ‡ãƒ¼ã‚¿ã®ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
            });
        };

        const calendarEl = document.getElementById('calendar');
        const currentMonthYearEl = document.getElementById('currentMonthYear');
        const prevMonthBtn = document.getElementById('prevMonthBtn');
        const nextMonthBtn = document.getElementById('nextMonthBtn');
        const modalEl = document.getElementById('modal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const modalDateEl = document.getElementById('modalDate');
        const eventInput = document.getElementById('eventInput');
        const todoListEl = document.getElementById('todoList');
        const newTodoInput = document.getElementById('newTodoInput');
        const addTodoBtn = document.getElementById('addTodoBtn');
        const saveBtn = document.getElementById('saveBtn');
        const incompleteTodosEl = document.getElementById('incompleteTodos');

        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let selectedDate = null;
        
        let holidays = {};
        holidays['2025-01-01'] = 'å…ƒæ—¥';
        holidays['2025-01-13'] = 'æˆäººã®æ—¥';
        holidays['2025-02-11'] = 'å»ºå›½è¨˜å¿µã®æ—¥';
        holidays['2025-03-20'] = 'æ˜¥åˆ†ã®æ—¥';
        holidays['2025-04-29'] = 'æ˜­å’Œã®æ—¥';
        holidays['2025-05-03'] = 'æ†²æ³•è¨˜å¿µæ—¥';
        holidays['2025-05-04'] = 'ã¿ã©ã‚Šã®æ—¥';
        holidays['2025-05-05'] = 'ã“ã©ã‚‚ã®æ—¥';
        holidays['2025-05-06'] = 'æŒ¯æ›¿ä¼‘æ—¥';
        holidays['2025-07-21'] = 'æµ·ã®æ—¥';
        holidays['2025-08-11'] = 'å±±ã®æ—¥';
        holidays['2025-08-15'] = 'æŒ¯æ›¿ä¼‘æ—¥';
        holidays['2025-09-22'] = 'æ•¬è€ã®æ—¥';
        holidays['2025-09-23'] = 'ç§‹åˆ†ã®æ—¥';
        holidays['2025-10-13'] = 'ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥';
        holidays['2025-11-03'] = 'æ–‡åŒ–ã®æ—¥';
        holidays['2025-11-23'] = 'å‹¤åŠ´æ„Ÿè¬ã®æ—¥';
        holidays['2025-11-29'] = 'æŒ¯æ›¿ä¼‘æ—¥';

        const generateDateKey = (year, month, day) => `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

        const renderCalendar = (year, month) => {
            calendarEl.innerHTML = '';
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const prevLastDay = new Date(year, month, 0);

            currentMonthYearEl.textContent = `${year}å¹´ ${month + 1}æœˆ`;

            const startDayIndex = firstDay.getDay();

            for (let i = startDayIndex; i > 0; i--) {
                const day = prevLastDay.getDate() - i + 1;
                const cell = document.createElement('div');
                cell.classList.add('day-cell', 'prev-month', 'p-2');
                cell.innerHTML = `<span class="day-number">${day}</span>`;
                calendarEl.appendChild(cell);
            }

            for (let i = 1; i <= lastDay.getDate(); i++) {
                const date = new Date(year, month, i);
                const dateKey = generateDateKey(year, month, i);
                const storedData = eventData[dateKey] || { event: '', todos: [] };

                const cell = document.createElement('div');
                cell.classList.add('day-cell', 'p-2', 'relative');
                cell.dataset.date = dateKey;

                if (date.getDay() === 0 || holidays[dateKey]) {
                    cell.classList.add('holiday');
                }
                if (date.getDay() === 6) {
                    cell.classList.add('saturday');
                }
                if (date.toDateString() === new Date().toDateString()) {
                    cell.classList.add('today');
                }

                const daySpan = document.createElement('span');
                daySpan.classList.add('day-number');
                daySpan.textContent = i;
                cell.appendChild(daySpan);

                if (holidays[dateKey]) {
                    const holidayLabel = document.createElement('div');
                    holidayLabel.classList.add('event-item', 'bg-red-200', 'text-red-800');
                    holidayLabel.textContent = holidays[dateKey];
                    cell.appendChild(holidayLabel);
                }

                if (storedData.event) {<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ»</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }
        .day-cell {
            min-height: 120px;
            border: 1px solid #f3f4f6;
            padding: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
            background-color: white;
            overflow: hidden;
        }
        .day-cell.prev-month, .day-cell.next-month {
            color: #d1d5db;
            background-color: #f9fafb;
        }
        .day-cell:not(.prev-month):not(.next-month):hover {
            background-color: #f0f9ff;
        }
        .day-number {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 2px;
        }
        .day-cell.today {
            background-color: #eff6ff;
            border: 2px solid #3b82f6;
        }
        .holiday { color: #ef4444; }
        .saturday { color: #3b82f6; }
        
        .event-item {
            font-size: 0.75rem;
            line-height: 1.2;
            padding: 2px 4px;
            border-radius: 3px;
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .event-item.event {
            background-color: #e5e7eb;
            font-weight: 500;
        }
        .todo-item {
            font-size: 0.75rem;
            color: #065f46;
            background-color: #d1fae5;
            border-radius: 3px;
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è¨­å®š */
        .calendar-scroll-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .main-container {
            width: 100%;
            margin-left: auto;
            margin-right: auto;
        }

        /* ã‚¹ãƒãƒ›è¡¨ç¤ºç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
        .mobile-layout .calendar-grid {
            min-width: 700px; /* æ¨ªå¹…ã‚’ç¢ºä¿ã—ã¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã›ã‚‹ */
        }
        .mobile-layout .day-cell {
            min-height: 90px;
        }
        .mobile-layout .main-container {
            max-width: 100%;
            padding: 0.5rem;
        }
        
        /* PCè¡¨ç¤ºç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .pc-layout .main-container {
            max-width: 1200px;
            padding: 2rem;
        }

        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º */
        .calendar-scroll-wrapper::-webkit-scrollbar {
            height: 6px;
        }
        .calendar-scroll-wrapper::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
    </style>
</head>
<body class="bg-gray-100 p-2 sm:p-4 pc-layout">
    <!-- è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ -->
    <div class="flex justify-center mb-4 space-x-2">
        <button id="mobileViewBtn" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-50 active:bg-blue-100 transition-colors">ã‚¹ãƒãƒ›è¡¨ç¤º</button>
        <button id="pcViewBtn" class="bg-white border border-blue-500 text-blue-600 px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-50 transition-colors">PCè¡¨ç¤º</button>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div id="appContainer" class="main-container space-y-6">
        
        <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="bg-white rounded-2xl shadow-sm p-4 sm:p-6">
            <div class="flex items-center justify-between mb-4">
                <h1 id="monthTitle" class="text-2xl font-bold text-gray-800">ğŸŒ»</h1>
                <div class="flex items-center space-x-3">
                    <button id="prevMonthBtn" class="p-2 hover:bg-gray-100 rounded-full transition-colors text-gray-600 font-bold">&lt;</button>
                    <span id="currentMonthYear" class="text-xl font-bold text-gray-700"></span>
                    <button id="nextMonthBtn" class="p-2 hover:bg-gray-100 rounded-full transition-colors text-gray-600 font-bold">&gt;</button>
                </div>
            </div>

            <div class="calendar-scroll-wrapper rounded-xl border border-gray-100">
                <div class="calendar-grid text-center font-bold bg-gray-50 text-gray-500 py-3 text-xs uppercase tracking-wider border-b border-gray-100">
                    <div class="holiday">æ—¥</div>
                    <div>æœˆ</div>
                    <div>ç«</div>
                    <div>æ°´</div>
                    <div>æœ¨</div>
                    <div>é‡‘</div>
                    <div class="saturday">åœŸ</div>
                </div>
                <div id="calendar" class="calendar-grid">
                    <!-- JSã§ç”Ÿæˆ -->
                </div>
            </div>
        </div>
        
        <!-- ç›®æ¨™ãƒ»èª²é¡Œç‚¹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-white rounded-2xl shadow-sm p-5">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-lg font-bold text-gray-800 flex items-center">
                        <span class="mr-2">ğŸ¯</span>ç›®æ¨™
                    </h2>
                    <button id="editGoalBtn" class="text-blue-500 text-sm font-bold hover:underline">ç·¨é›†</button>
                </div>
                <div id="goalDisplay" class="text-gray-600 text-sm whitespace-pre-wrap min-h-[80px] bg-gray-50 p-3 rounded-xl border border-dashed border-gray-200"></div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm p-5">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-lg font-bold text-gray-800 flex items-center">
                        <span class="mr-2">ğŸ’¡</span>èª²é¡Œç‚¹
                    </h2>
                    <button id="editIssueBtn" class="text-blue-500 text-sm font-bold hover:underline">ç·¨é›†</button>
                </div>
                <div id="issueDisplay" class="text-gray-600 text-sm whitespace-pre-wrap min-h-[80px] bg-gray-50 p-3 rounded-xl border border-dashed border-gray-200"></div>
            </div>
        </div>

        <!-- TODOã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="bg-white rounded-2xl shadow-sm p-5">
            <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                <span class="mr-2">ğŸ“</span>æœªå®Œäº†ã®ã‚„ã‚‹ã“ã¨
            </h2>
            <div id="incompleteTodos" class="space-y-2"></div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm p-5">
            <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                <span class="mr-2">âœ…</span>å®Œäº†æ¸ˆã¿ã®ã‚„ã‚‹ã“ã¨
            </h2>
            <div id="completedTodos" class="space-y-2"></div>
        </div>

        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± -->
        <div class="bg-gray-800 rounded-2xl p-4 text-white text-center">
            <p class="text-xs text-gray-400 mb-1">ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</p>
            <p id="userIdDisplay" class="font-mono text-xs break-all opacity-80"></p>
        </div>
    </div>

    <!-- äºˆå®šå…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
        <div class="bg-white rounded-3xl p-6 w-full max-w-md shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modalDate" class="text-xl font-bold text-gray-800"></h2>
                <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">äºˆå®š</label>
                    <div class="flex space-x-2">
                        <textarea id="eventInput" class="flex-1 h-20 p-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm" placeholder="ä½•ã‚’ã™ã‚‹ï¼Ÿ"></textarea>
                        <input type="color" id="eventColor" class="w-12 h-12 rounded-xl border-0 p-1 cursor-pointer" value="#3b82f6">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">TODOã‚’è¿½åŠ </label>
                    <div class="flex space-x-2">
                        <input type="text" id="newTodoInput" class="flex-1 p-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm" placeholder="ã‚„ã‚‹ã“ã¨...">
                        <button id="addTodoBtn" class="bg-blue-600 text-white px-4 rounded-xl font-bold hover:bg-blue-700 transition-colors">è¿½åŠ </button>
                    </div>
                </div>

                <div id="todoList" class="space-y-2 max-h-40 overflow-y-auto"></div>

                <div class="flex space-x-2 pt-2">
                    <button id="saveBtn" class="flex-1 bg-green-600 text-white py-3 rounded-2xl font-bold hover:bg-green-700 transition-shadow">ä¿å­˜ã—ã¦é–‰ã˜ã‚‹</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç›®æ¨™ãƒ»èª²é¡Œç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="notesModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
        <div class="bg-white rounded-3xl p-6 w-full max-w-md shadow-2xl">
            <h2 id="notesModalTitle" class="text-xl font-bold text-gray-800 mb-4"></h2>
            <textarea id="notesInput" class="w-full h-40 p-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm mb-4"></textarea>
            <div class="flex space-x-2">
                <button id="cancelNotesBtn" class="flex-1 bg-gray-100 text-gray-600 py-3 rounded-2xl font-bold">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="saveNotesBtn" class="flex-1 bg-blue-600 text-white py-3 rounded-2xl font-bold">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <div id="statusMessage" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-gray-900 text-white text-xs py-2 px-4 rounded-full shadow-xl transition-all duration-300 opacity-0 z-[100]"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ç’°å¢ƒè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyD1as9zQr8P6k8Up9Y4FnO3DYroyvgMnAM",
            authDomain: "karennda-e8465.firebaseapp.com",
            projectId: "karennda-e8465",
            storageBucket: "karennda-e8465.firebasestorage.app",
            messagingSenderId: "1023443880200",
            appId: "1:1023443880200:web:ee995edd613fbc626544bd",
            measurementId: "G-E9Y0L9P95V"
        };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'karennda-app';
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // çŠ¶æ…‹ç®¡ç†
        let currentUserId = null;
        let eventData = {};
        let monthlyNotes = {};
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth();
        let selectedDate = null;
        let currentEditingField = null;

        // DOMè¦ç´ 
        const elements = {
            calendar: document.getElementById('calendar'),
            monthYear: document.getElementById('currentMonthYear'),
            userId: document.getElementById('userIdDisplay'),
            goal: document.getElementById('goalDisplay'),
            issue: document.getElementById('issueDisplay'),
            incomplete: document.getElementById('incompleteTodos'),
            completed: document.getElementById('completedTodos'),
            status: document.getElementById('statusMessage'),
            modal: document.getElementById('modal'),
            notesModal: document.getElementById('notesModal')
        };

        const currentYearMonth = () => `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;

        const showStatus = (msg) => {
            elements.status.textContent = msg;
            elements.status.style.opacity = '1';
            setTimeout(() => elements.status.style.opacity = '0', 3000);
        };

        // FirebaseåŒæœŸ
        const initSync = async () => {
            try {
                const cred = await signInAnonymously(auth);
                currentUserId = cred.user.uid;
                elements.userId.textContent = currentUserId;
                
                // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'calendar_events'), (snap) => {
                    eventData = {};
                    snap.forEach(doc => eventData[doc.id] = doc.data());
                    renderAll();
                }, (err) => console.error("Sync Error:", err));

                // æœˆé–“ãƒ¡ãƒ¢ã®åŒæœŸ
                syncMonthlyNotes();
            } catch (err) {
                showStatus("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—");
                console.error(err);
            }
        };

        const syncMonthlyNotes = () => {
            const path = `/artifacts/${appId}/public/data/monthly_notes/${currentYearMonth()}`;
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'monthly_notes', currentYearMonth()), (d) => {
                if (d.exists()) {
                    monthlyNotes = d.data();
                    elements.goal.textContent = monthlyNotes.goal || "ç›®æ¨™ã‚’è¨­å®šã—ã¾ã—ã‚‡ã†";
                    elements.issue.textContent = monthlyNotes.issue || "èª²é¡Œã‚’æ•´ç†ã—ã¾ã—ã‚‡ã†";
                } else {
                    monthlyNotes = { goal: "", issue: "" };
                    elements.goal.textContent = "ç›®æ¨™ã‚’è¨­å®šã—ã¾ã—ã‚‡ã†";
                    elements.issue.textContent = "èª²é¡Œã‚’æ•´ç†ã—ã¾ã—ã‚‡ã†";
                }
            });
        };

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»
        const renderAll = () => {
            elements.calendar.innerHTML = '';
            elements.monthYear.textContent = `${currentYear}å¹´ ${currentMonth + 1}æœˆ`;

            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const lastDate = new Date(currentYear, currentMonth + 1, 0).getDate();
            const prevLastDate = new Date(currentYear, currentMonth, 0).getDate();

            // å‰æœˆåˆ†
            for (let i = firstDay; i > 0; i--) {
                createCell(prevLastDate - i + 1, true);
            }
            // å½“æœˆåˆ†
            for (let i = 1; i <= lastDate; i++) {
                createCell(i, false);
            }
            // ç¿Œæœˆåˆ†
            const remaining = 42 - (firstDay + lastDate);
            for (let i = 1; i <= remaining; i++) {
                createCell(i, true);
            }

            renderTodoLists();
        };

        const createCell = (day, isOtherMonth) => {
            const cell = document.createElement('div');
            cell.className = `day-cell ${isOtherMonth ? 'prev-month' : ''}`;
            
            if (!isOtherMonth) {
                const dateKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const data = eventData[dateKey] || {};
                const dateObj = new Date(currentYear, currentMonth, day);
                
                if (dateObj.toDateString() === new Date().toDateString()) cell.classList.add('today');
                if (dateObj.getDay() === 0) cell.classList.add('holiday');
                if (dateObj.getDay() === 6) cell.classList.add('saturday');

                let html = `<div class="day-number">${day}</div>`;
                if (data.event) {
                    const bgColor = data.color ? data.color + '22' : '#e5e7eb';
                    const borderColor = data.color || '#94a3b8';
                    html += `<div class="event-item event" style="background-color:${bgColor}; border-left: 3px solid ${borderColor}">${data.event}</div>`;
                }
                if (data.todos) {
                    data.todos.filter(t => !t.completed).forEach(t => {
                        html += `<div class="event-item todo-item">ãƒ» ${t.text}</div>`;
                    });
                }
                cell.innerHTML = html;
                cell.onclick = () => openModal(dateKey);
            } else {
                cell.innerHTML = `<div class="day-number opacity-20">${day}</div>`;
            }
            elements.calendar.appendChild(cell);
        };

        // TODOãƒªã‚¹ãƒˆæç”»
        const renderTodoLists = () => {
            elements.incomplete.innerHTML = '';
            elements.completed.innerHTML = '';
            
            const incList = [];
            const compList = [];

            Object.entries(eventData).forEach(([date, data]) => {
                if (!data.todos) return;
                const dayStr = date.split('-')[2];
                data.todos.forEach((t, idx) => {
                    const item = { date, day: dayStr, text: t.text, idx };
                    if (t.completed) compList.push(item);
                    else incList.push(item);
                });
            });

            const createTodoEl = (item, isCompleted) => {
                const div = document.createElement('div');
                div.className = `flex items-center p-3 rounded-xl shadow-sm border ${isCompleted ? 'bg-gray-50 border-gray-100 grayscale' : 'bg-blue-50 border-blue-100'}`;
                div.innerHTML = `
                    <input type="checkbox" ${isCompleted ? 'checked' : ''} class="w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-3">
                    <div class="flex-1">
                        <span class="text-[10px] font-bold text-gray-400 block">${item.day}æ—¥</span>
                        <span class="text-sm ${isCompleted ? 'line-through text-gray-400' : 'text-gray-700 font-medium'}">${item.text}</span>
                    </div>
                `;
                div.querySelector('input').onchange = (e) => toggleTodo(item.date, item.idx, e.target.checked);
                return div;
            };

            incList.sort((a,b) => a.date.localeCompare(b.date)).forEach(i => elements.incomplete.appendChild(createTodoEl(i, false)));
            compList.sort((a,b) => a.date.localeCompare(b.date)).forEach(i => elements.completed.appendChild(createTodoEl(i, true)));
            
            if (incList.length === 0) elements.incomplete.innerHTML = '<p class="text-gray-400 text-sm italic">ã™ã¹ã¦å®Œäº†ã—ã¾ã—ãŸï¼âœ¨</p>';
            if (compList.length === 0) elements.completed.innerHTML = '<p class="text-gray-400 text-sm italic">ã¾ã å®Œäº†ã—ãŸé …ç›®ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
        };

        // ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ
        const openModal = (dateKey) => {
            selectedDate = dateKey;
            const data = eventData[dateKey] || { event: "", color: "#3b82f6", todos: [] };
            document.getElementById('modalDate').textContent = dateKey.replace(/-/g, '/');
            document.getElementById('eventInput').value = data.event || "";
            document.getElementById('eventColor').value = data.color || "#3b82f6";
            renderModalTodos(data.todos || []);
            elements.modal.classList.replace('hidden', 'flex');
        };

        const renderModalTodos = (todos) => {
            const list = document.getElementById('todoList');
            list.innerHTML = '';
            todos.forEach((t, i) => {
                const div = document.createElement('div');
                div.className = "flex items-center space-x-2 bg-gray-50 p-2 rounded-lg border border-gray-100";
                div.innerHTML = `
                    <span class="flex-1 text-xs ${t.completed ? 'line-through text-gray-400' : ''}">${t.text}</span>
                    <button class="text-red-400 hover:text-red-600 text-xs font-bold">å‰Šé™¤</button>
                `;
                div.querySelector('button').onclick = () => {
                    todos.splice(i, 1);
                    saveCurrentDateData({ todos });
                    renderModalTodos(todos);
                };
                list.appendChild(div);
            });
        };

        // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
        const saveCurrentDateData = async (overrides) => {
            if (!currentUserId) return;
            const data = { ...eventData[selectedDate], ...overrides };
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'calendar_events', selectedDate), data);
        };

        const toggleTodo = async (date, idx, state) => {
            const data = eventData[date];
            data.todos[idx].completed = state;
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'calendar_events', date), data);
            showStatus(state ? "ãŠç–²ã‚Œæ§˜ã§ã™ï¼ğŸ‰" : "å†é–‹ã—ã¾ã—ãŸ");
        };

        const saveNotes = async () => {
            const text = document.getElementById('notesInput').value;
            const updated = { ...monthlyNotes, [currentEditingField]: text };
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'monthly_notes', currentYearMonth()), updated);
            elements.notesModal.classList.replace('flex', 'hidden');
            showStatus("ä¿å­˜ã—ã¾ã—ãŸ");
        };

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('saveBtn').onclick = async () => {
            const event = document.getElementById('eventInput').value;
            const color = document.getElementById('eventColor').value;
            await saveCurrentDateData({ event, color });
            elements.modal.classList.replace('flex', 'hidden');
            showStatus("æ›´æ–°ã—ã¾ã—ãŸ");
        };

        document.getElementById('addTodoBtn').onclick = () => {
            const input = document.getElementById('newTodoInput');
            const text = input.value.trim();
            if (!text) return;
            const todos = eventData[selectedDate]?.todos || [];
            todos.push({ text, completed: false });
            saveCurrentDateData({ todos });
            renderModalTodos(todos);
            input.value = '';
        };

        document.getElementById('editGoalBtn').onclick = () => {
            currentEditingField = 'goal';
            document.getElementById('notesModalTitle').textContent = "ä»Šæœˆã®ç›®æ¨™ã‚’ç·¨é›†";
            document.getElementById('notesInput').value = monthlyNotes.goal || "";
            elements.notesModal.classList.replace('hidden', 'flex');
        };

        document.getElementById('editIssueBtn').onclick = () => {
            currentEditingField = 'issue';
            document.getElementById('notesModalTitle').textContent = "ä»Šæœˆã®èª²é¡Œç‚¹ã‚’ç·¨é›†";
            document.getElementById('notesInput').value = monthlyNotes.issue || "";
            elements.notesModal.classList.replace('hidden', 'flex');
        };

        document.getElementById('saveNotesBtn').onclick = saveNotes;
        document.getElementById('cancelNotesBtn').onclick = () => elements.notesModal.classList.replace('flex', 'hidden');
        document.getElementById('closeModalBtn').onclick = () => elements.modal.classList.replace('flex', 'hidden');

        document.getElementById('prevMonthBtn').onclick = () => {
            currentMonth--;
            if (currentMonth < 0) { currentMonth = 11; currentYear--; }
            syncMonthlyNotes();
            renderAll();
        };

        document.getElementById('nextMonthBtn').onclick = () => {
            currentMonth++;
            if (currentMonth > 11) { currentMonth = 0; currentYear++; }
            syncMonthlyNotes();
            renderAll();
        };

        // è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        const switchView = (isMobile) => {
            document.body.className = isMobile ? 'bg-gray-100 p-2 sm:p-4 mobile-layout' : 'bg-gray-100 p-2 sm:p-4 pc-layout';
            document.getElementById('mobileViewBtn').className = isMobile ? 'bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md' : 'bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-50 transition-colors';
            document.getElementById('pcViewBtn').className = !isMobile ? 'bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md' : 'bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-50 transition-colors';
            renderAll();
        };

        document.getElementById('mobileViewBtn').onclick = () => switchView(true);
        document.getElementById('pcViewBtn').onclick = () => switchView(false);

        // åˆæœŸåŒ–
        initSync();
    </script>
</body>
</html>
